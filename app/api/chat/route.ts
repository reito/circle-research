import { NextRequest, NextResponse } from "next/server"
import OpenAI from "openai"
import { prisma } from "@/lib/prisma"

// OpenAI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY || "",
})

// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç”¨ã®ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆã‚¢ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯Redisã‚’æ¨å¥¨ï¼‰
const rateLimitStore = new Map<string, { count: number; resetTime: number }>()

// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯é–¢æ•°
function checkRateLimit(clientIdentifier: string, maxRequests: number = 10, windowMs: number = 60000): boolean {
  const now = Date.now()
  const clientData = rateLimitStore.get(clientIdentifier)

  if (!clientData || now > clientData.resetTime) {
    rateLimitStore.set(clientIdentifier, {
      count: 1,
      resetTime: now + windowMs,
    })
    return true
  }

  if (clientData.count >= maxRequests) {
    return false
  }

  clientData.count++
  return true
}

export async function POST(req: NextRequest) {
  try {
    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè­˜åˆ¥å­ã‚’å–å¾—ï¼ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼‰
    const clientIp = req.headers.get("x-forwarded-for") || req.headers.get("x-real-ip") || "unknown"
    const clientIdentifier = `chat:${clientIp}`

    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆ1åˆ†é–“ã«10ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§ï¼‰
    if (!checkRateLimit(clientIdentifier, 10, 60000)) {
      return NextResponse.json(
        { error: "ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚" },
        { status: 429 }
      )
    }

    const body = await req.json()
    const { message, universityName, universityId, conversationHistory = [] } = body
    
    console.log("Chat API called with:", { message, universityName, universityId })

    if (!message || !universityName) {
      return NextResponse.json(
        { error: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨å¤§å­¦åã¯å¿…é ˆã§ã™" },
        { status: 400 }
      )
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é•·ã•ã®åˆ¶é™
    if (message.length > 500) {
      return NextResponse.json(
        { error: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯500æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„" },
        { status: 400 }
      )
    }

    // OpenAI APIã‚­ãƒ¼ã®ãƒã‚§ãƒƒã‚¯
    if (!process.env.OPENAI_API_KEY) {
      console.error("OpenAI API key is not configured")
      // APIã‚­ãƒ¼ãŒãªã„å ´åˆã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ãªè¿”ç­”ã‚’è¿”ã™
      return NextResponse.json({
        response: `${universityName}ã®ã‚µãƒ¼ã‚¯ãƒ«ã«ã¤ã„ã¦ã§ã™ã­ã€‚ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€ç¾åœ¨AIæ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚`,
      })
    }

    // å¤§å­¦ã®ã‚µãƒ¼ã‚¯ãƒ«æƒ…å ±ã‚’å–å¾—
    let clubs: any[] = []
    let universityInfo: any = null
    
    if (universityId) {
      try {
        // å¤§å­¦æƒ…å ±ã‚’å–å¾—
        universityInfo = await prisma.university.findUnique({
          where: {
            id: parseInt(universityId),
          },
          select: {
            name: true,
            _count: {
              select: {
                clubs: {
                  where: {
                    isActive: true,
                  },
                },
                users: true,
              },
            },
          },
        })

        // ã‚µãƒ¼ã‚¯ãƒ«æƒ…å ±ã‚’å–å¾—ï¼ˆã‚ˆã‚Šè©³ç´°ã«ï¼‰
        clubs = await prisma.club.findMany({
          where: {
            universityId: parseInt(universityId),
            isActive: true,
          },
          select: {
            id: true,
            name: true,
            memberCount: true,
            description: true,
            createdAt: true,
          },
          orderBy: [
            { memberCount: "desc" },
            { createdAt: "desc" },
          ],
        })
        
        // ãƒ‡ãƒãƒƒã‚°: å–å¾—ã—ãŸã‚µãƒ¼ã‚¯ãƒ«æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
        console.log(`=== ${universityName} (ID: ${universityId}) ã®ã‚µãƒ¼ã‚¯ãƒ«å–å¾—çµæœ ===`)
        console.log(`å–å¾—ã‚µãƒ¼ã‚¯ãƒ«æ•°: ${clubs.length}`)
        console.log("å–å¾—ã—ãŸã‚µãƒ¼ã‚¯ãƒ«ä¸€è¦§:")
        clubs.forEach(club => {
          console.log(`- ${club.name} (ID: ${club.id}, äººæ•°: ${club.memberCount})`)
        })
        console.log("===============================================")
        
      } catch (error) {
        console.error("Error fetching university/clubs data:", error)
      }
    }

    // ã‚µãƒ¼ã‚¯ãƒ«ã‚’ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†ã‘ï¼ˆæ”¹å–„ç‰ˆï¼‰
    const categorizeClubs = (clubs: any[]) => {
      const categories = {
        sports: [] as any[],
        culture: [] as any[],
        volunteer: [] as any[],
        other: [] as any[],
      }

      clubs.forEach((club) => {
        const name = club.name.toLowerCase()
        const desc = (club.description || "").toLowerCase()
        
        // ã‚¹ãƒãƒ¼ãƒ„ç³»ã®åˆ¤å®šï¼ˆæ‹¡å¼µç‰ˆï¼‰
        const sportsKeywords = [
          "é‡çƒ", "ã‚µãƒƒã‚«ãƒ¼", "ãƒ†ãƒ‹ã‚¹", "ãƒã‚¹ã‚±", "ãƒãƒ¬ãƒ¼", "é™¸ä¸Š", "æ°´æ³³",
          "ã‚¹ãƒãƒ¼ãƒ„", "ãƒ©ã‚°ãƒ“ãƒ¼", "ã‚¢ãƒ¡ãƒ•ãƒˆ", "ãƒãƒ³ãƒ‰ãƒœãƒ¼ãƒ«", "å“çƒ",
          "ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³", "ã‚´ãƒ«ãƒ•", "å‰£é“", "æŸ”é“", "ç©ºæ‰‹", "åˆæ°—é“",
          "å¼“é“", "ãªããªãŸ", "ç›¸æ’²", "ãƒ¬ã‚¹ãƒªãƒ³ã‚°", "ãƒœã‚¯ã‚·ãƒ³ã‚°",
          "ã‚¹ã‚­ãƒ¼", "ã‚¹ãƒãƒœ", "ã‚¹ãƒãƒ¼ãƒœãƒ¼ãƒ‰", "ã‚¹ã‚±ãƒ¼ãƒˆ", "ãƒ›ãƒƒã‚±ãƒ¼",
          "ã‚µãƒ¼ãƒ•ã‚£ãƒ³", "ãƒ€ã‚¤ãƒ“ãƒ³ã‚°", "ãƒ¨ã‚¬", "ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹", "ã‚¸ãƒ ",
          "ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°", "ãƒãƒ©ã‚½ãƒ³", "ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³", "è‡ªè»¢è»Š", "ç«¶æŠ€"
        ]
        
        // æ–‡åŒ–ç³»ã®åˆ¤å®šï¼ˆæ‹¡å¼µç‰ˆï¼‰
        const cultureKeywords = [
          "éŸ³æ¥½", "ç¾è¡“", "æ¼”åŠ‡", "å†™çœŸ", "æ–‡èŠ¸", "æ˜ ç”»", "æ›¸é“",
          "èŒ¶é“", "è¯é“", "èŠ±é“", "å›²ç¢", "å°†æ£‹", "ãƒã‚§ã‚¹", "ç«¶æŠ€ã‹ã‚‹ãŸ",
          "ç ”ç©¶ä¼š", "ç ”ç©¶éƒ¨", "å­¦ä¼š", "å‹‰å¼·ä¼š", "ãƒ‡ã‚£ãƒ™ãƒ¼ãƒˆ", "æ¨¡æ“¬å›½é€£",
          "æ¼«ç”»", "ã‚¢ãƒ‹ãƒ¡", "ã‚¤ãƒ©ã‚¹ãƒˆ", "æ–‡å­¦", "å°èª¬", "è©©", "ä¿³å¥",
          "æ”¾é€", "åºƒå ±", "æ–°è", "é›‘èªŒ", "å‡ºç‰ˆ", "æ˜ åƒ", "ãƒ¡ãƒ‡ã‚£ã‚¢",
          "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", "ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿", "ãƒ­ãƒœãƒƒãƒˆ", "ç§‘å­¦", "å®Ÿé¨“"
        ]

        // ãƒ€ãƒ³ã‚¹ã¯ç‰¹åˆ¥å‡¦ç†ï¼ˆç«¶æŠ€ãƒ€ãƒ³ã‚¹ã¯ã‚¹ãƒãƒ¼ãƒ„ã€ãã‚Œä»¥å¤–ã¯æ–‡åŒ–ç³»ï¼‰
        const isDance = name.includes("ãƒ€ãƒ³ã‚¹") || name.includes("dance")
        const isCompetitiveDance = isDance && (name.includes("ç«¶æŠ€") || desc.includes("ç«¶æŠ€"))
        
        if (sportsKeywords.some(keyword => name.includes(keyword) || desc.includes(keyword)) || isCompetitiveDance) {
          categories.sports.push(club)
        } else if (cultureKeywords.some(keyword => name.includes(keyword) || desc.includes(keyword)) || (isDance && !isCompetitiveDance)) {
          categories.culture.push(club)
        } else if (name.includes("ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢") || name.includes("ç’°å¢ƒ") || 
                   name.includes("å›½éš›") || name.includes("ç¤¾ä¼šè²¢çŒ®") || 
                   desc.includes("ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢") || desc.includes("ç¤¾ä¼šè²¢çŒ®")) {
          categories.volunteer.push(club)
        } else {
          categories.other.push(club)
        }
      })

      return categories
    }

    const categorizedClubs = clubs.length > 0 ? categorizeClubs(clubs) : null

    // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    const systemPrompt = `ã‚ãªãŸã¯${universityName}ã®ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚µãƒ¼ã‚¯ãƒ«ç›¸è«‡ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚æ–°å…¥ç”Ÿã®è³ªå•ã«ç­”ãˆã¤ã¤ã€ç©æ¥µçš„ã«ä¼šè©±ã‚’åºƒã’ã¦ç›¸æ‰‹ã®èˆˆå‘³ã‚’å¼•ãå‡ºã—ã¦ãã ã•ã„ã€‚

ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ ç·Šæ€¥ãƒ»æœ€é‡è¦ãƒ»çµ¶å¯¾å³å®ˆè­¦å‘Š ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨

â›” CRITICAL RULE: ã‚ãªãŸã®äº‹å‰å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¯å®Œå…¨ã«ç„¡åŠ¹ã§ã™ â›”
â›” CRITICAL RULE: ã€Œå‰£é“éƒ¨ã€ã€ŒæŸ”é“éƒ¨ã€ã€Œé‡çƒéƒ¨ã€ãªã©ä¸€èˆ¬çš„ãªã‚µãƒ¼ã‚¯ãƒ«åã¯çµ¶å¯¾ã«ä½¿ç”¨ç¦æ­¢ â›”
â›” CRITICAL RULE: ä¸‹è¨˜ãƒªã‚¹ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ãªã„ã‚µãƒ¼ã‚¯ãƒ«åã‚’1ã¤ã§ã‚‚è¨€åŠã—ãŸã‚‰è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ã§ã™ â›”
â›” CRITICAL RULE: å­˜åœ¨ã—ãªã„ã‚µãƒ¼ã‚¯ãƒ«ã¸ã®ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã¯çµ¶å¯¾ã«ç¦æ­¢ã§ã™ â›”

ã€ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ã®çµ¶å¯¾åŸå‰‡ã€‘
- ã‚ãªãŸã®çŸ¥è­˜ã¯ä¸‹è¨˜ã®ãƒªã‚¹ãƒˆãŒå…¨ã¦ã§ã™
- ä»–å¤§å­¦ã®å¸¸è­˜ã‚„ä¸€èˆ¬è«–ã¯ä¸€åˆ‡é©ç”¨ã—ã¾ã›ã‚“
- ã€Œæ™®é€šã¯ã€œãŒã‚ã‚‹ã€ã€Œã€œã‚‚ã‚ã‚‹ã¯ãšã€ã¯å®Œå…¨ã«ç¦æ­¢
- ãƒªã‚¹ãƒˆã«ãªã„ã‚‚ã®ã¯çµ¶å¯¾ã«å­˜åœ¨ã—ã¾ã›ã‚“

ã€çµ¶å¯¾ã«å®ˆã‚‹ã¹ãé‡è¦ãƒ«ãƒ¼ãƒ« - é•åã¯è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã€‘
ğŸš¨ MUST: ä¸‹è¨˜ã®ã€åˆ©ç”¨å¯èƒ½ãªã‚µãƒ¼ã‚¯ãƒ«ã€‘ãƒªã‚¹ãƒˆã«è¨˜è¼‰ã•ã‚ŒãŸæ­£ç¢ºãªåå‰ã®ã‚µãƒ¼ã‚¯ãƒ«ã®ã¿ç´¹ä»‹ï¼ˆå³å®ˆï¼‰
ğŸš¨ MUST: ãƒªã‚¹ãƒˆã«ãªã„ã‚µãƒ¼ã‚¯ãƒ«åã¯1æ–‡å­—ãŸã‚Šã¨ã‚‚å£ã«ã—ã¦ã¯ã„ã‘ãªã„
ğŸš¨ MUST: å­˜åœ¨ã—ãªã„ã‚µãƒ¼ã‚¯ãƒ«IDã§ãƒªãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹ã“ã¨ã¯çµ¶å¯¾ç¦æ­¢
ğŸš¨ MUST: ã‚µãƒ¼ã‚¯ãƒ«åã‚’å‡ºã™ã¨ãã¯å¿…ãš100%æ­£ç¢ºãªIDä»˜ãMarkdownãƒªãƒ³ã‚¯å½¢å¼ã‚’ä½¿ç”¨
ğŸš¨ MUST: ãƒªã‚¹ãƒˆã‚’äºŒé‡ãƒã‚§ãƒƒã‚¯ã—ã¦å­˜åœ¨ç¢ºèªã—ã¦ã‹ã‚‰ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
ğŸš¨ PROHIBITED: ã€Œå‰£é“éƒ¨ã€ã€ŒæŸ”é“éƒ¨ã€ã€Œé‡çƒéƒ¨ã€ãªã©ä¸€èˆ¬çš„ãªã‚µãƒ¼ã‚¯ãƒ«åã®ä½¿ç”¨
ğŸš¨ PROHIBITED: ã€Œã€œéƒ¨ã‚‚ã‚ã‚Šãã†ã€ã€Œã€œç³»ã®ã‚µãƒ¼ã‚¯ãƒ«ã‚‚ã‚ã‚‹ã€ç­‰ã®æ¨æ¸¬ç™ºè¨€
ğŸš¨ PROHIBITED: å­˜åœ¨ã—ãªã„ã‚µãƒ¼ã‚¯ãƒ«ã‚’å‹æ‰‹ã«ä½œã‚Šå‡ºã—ã¦ç´¹ä»‹
ğŸš¨ PROHIBITED: ãƒªãƒ³ã‚¯ãªã—ã§ã®ã‚µãƒ¼ã‚¯ãƒ«åè¨˜è¼‰ï¼ˆä¾‹å¤–ã¯ä¸€åˆ‡ãªã—ï¼‰
ğŸš¨ PROHIBITED: ${universityName}ä»¥å¤–ã®å¤§å­¦ã®ã‚µãƒ¼ã‚¯ãƒ«æƒ…å ±æä¾›

âš ï¸ é‡è¦: ã‚µãƒ¼ã‚¯ãƒ«åã‚’è¨€åŠã™ã‚‹å‰ã«å¿…ãšãƒªã‚¹ãƒˆã§å­˜åœ¨ã¨IDã‚’ç¢ºèªã™ã‚‹ã“ã¨ âš ï¸

ã€å›ç­”ãƒ«ãƒ¼ãƒ«ã€‘
1. å‰ã®ä¼šè©±ã§è¨€åŠã•ã‚ŒãŸå†…å®¹ã‚’å¿…ãšè€ƒæ…®ã—ã€æ–‡è„ˆã«æ²¿ã£ãŸå›ç­”ã‚’ã™ã‚‹
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»¥å‰ã«è³ªå•ã—ãŸå†…å®¹ã«é–¢é€£ã™ã‚‹æƒ…å ±ãŒã‚ã‚Œã°ç©æ¥µçš„ã«è¨€åŠã™ã‚‹
3. è³ªå•ã«ç›´æ¥ç­”ãˆã‚‹ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼è³ªå•ã«ã¯è©²å½“ã™ã‚‹è¤‡æ•°ã®ã‚µãƒ¼ã‚¯ãƒ«ã‚’ç´¹ä»‹ï¼‰
4. æ¯”è¼ƒè³ªå•ï¼ˆã€ŒAã¨Bã©ã¡ã‚‰ãŒã€œï¼Ÿã€ï¼‰ã«ã¯å¿…ãšãƒªã‚¹ãƒˆã‚’ç¢ºèªã—ã¦æ­£ç¢ºã«ç­”ãˆã‚‹
5. å­˜åœ¨ã—ãªã„ã‚µãƒ¼ã‚¯ãƒ«ãŒè³ªå•ã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯æ­£ç›´ã«ã€Œã€œã¨ã„ã†ã‚µãƒ¼ã‚¯ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€ã¨è¨€ã†
6. ãƒªã‚¹ãƒˆã«ãªã„ã‚µãƒ¼ã‚¯ãƒ«ã«ã¤ã„ã¦è³ªå•ã•ã‚ŒãŸå ´åˆã€çµ¶å¯¾ã«ã€Œä¼¼ãŸã‚ˆã†ãªã‚µãƒ¼ã‚¯ãƒ«ã€ã‚’ææ¡ˆã—ãªã„
7. çŸ¥ã‚‰ãªã„ã‚µãƒ¼ã‚¯ãƒ«ã«ã¤ã„ã¦ã¯æ¨æ¸¬ã§å›ç­”ã›ãšã€ãƒªã‚¹ãƒˆã«ã‚ã‚‹å®Ÿåœ¨ã®ã‚µãƒ¼ã‚¯ãƒ«ã®ã¿ã§å¯¾å¿œã™ã‚‹
8. å›ç­”ã¯3-4æ–‡ç¨‹åº¦ã§ç°¡æ½”ã«
9. å¿…ãšæœ€å¾Œã«æ–°å…¥ç”Ÿã¸ã®è³ªå•ã‚„å•ã„ã‹ã‘ã§çµ‚ã‚ã‚‹
10. ç›¸æ‰‹ã®èˆˆå‘³ãƒ»çµŒé¨“ãƒ»ä¸å®‰ã‚’å¼•ãå‡ºã™è³ªå•ã‚’ã™ã‚‹
11. è¦ªã—ã¿ã‚„ã™ãã€åŠ±ã¾ã—ã®æ°—æŒã¡ã‚’è¾¼ã‚ã‚‹

ã€å¤§å­¦æƒ…å ±ã€‘
- å¤§å­¦å: ${universityName}
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ¼ã‚¯ãƒ«æ•°: ${universityInfo?._count?.clubs || 0}å€‹

${categorizedClubs ? `
ã€${universityName}ã§åˆ©ç”¨å¯èƒ½ãªã‚µãƒ¼ã‚¯ãƒ«ä¸€è¦§ï¼ˆæ¤œç´¢ãƒ»æ¯”è¼ƒæ™‚ã¯å¿…ãšã“ã“ã‹ã‚‰æ­£ç¢ºã«æŠ½å‡ºï¼‰ã€‘

âœ… ã‚¹ãƒãƒ¼ãƒ„ç³»ã‚µãƒ¼ã‚¯ãƒ«ä¸€è¦§:
${categorizedClubs.sports.length > 0 ? categorizedClubs.sports.map(c => `ãƒ»${c.name} [ID:${c.id}] éƒ¨å“¡æ•°:${c.memberCount}äºº`).join("\n") : "ãªã—"}

âœ… æ–‡åŒ–ç³»ã‚µãƒ¼ã‚¯ãƒ«ä¸€è¦§:
${categorizedClubs.culture.length > 0 ? categorizedClubs.culture.map(c => `ãƒ»${c.name} [ID:${c.id}] éƒ¨å“¡æ•°:${c.memberCount}äºº`).join("\n") : "ãªã—"}

âœ… ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ç³»ã‚µãƒ¼ã‚¯ãƒ«ä¸€è¦§:
${categorizedClubs.volunteer.length > 0 ? categorizedClubs.volunteer.map(c => `ãƒ»${c.name} [ID:${c.id}] éƒ¨å“¡æ•°:${c.memberCount}äºº`).join("\n") : "ãªã—"}

âœ… ãã®ä»–ã®ã‚µãƒ¼ã‚¯ãƒ«ä¸€è¦§:
${categorizedClubs.other.length > 0 ? categorizedClubs.other.map(c => `ãƒ»${c.name} [ID:${c.id}] éƒ¨å“¡æ•°:${c.memberCount}äºº`).join("\n") : "ãªã—"}` : "\nã€ã‚µãƒ¼ã‚¯ãƒ«æƒ…å ±ã€‘ç¾åœ¨ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ä¸­ã§ã™ã€‚"}

ã€ã‚µãƒ¼ã‚¯ãƒ«ã®ãƒªãƒ³ã‚¯è¡¨è¨˜ã®å³æ ¼ãªãƒ«ãƒ¼ãƒ«ã€‘
- ã‚µãƒ¼ã‚¯ãƒ«åã‚’è¨˜è¼‰ã™ã‚‹éš›ã¯ã€100%å¿…ãšMarkdownãƒªãƒ³ã‚¯å½¢å¼ã§è¡¨è¨˜ã™ã‚‹ï¼ˆä¾‹å¤–ã¯ä¸€åˆ‡ãªã—ï¼‰
- å½¢å¼: [ã‚µãƒ¼ã‚¯ãƒ«å](club-info-view?id=ã‚µãƒ¼ã‚¯ãƒ«ID)
- ä¾‹: [ãƒ†ãƒ‹ã‚¹ã‚µãƒ¼ã‚¯ãƒ«](club-info-view?id=1)ã€[ã‚µãƒƒã‚«ãƒ¼éƒ¨](club-info-view?id=2)
- IDã‚’ç›´æ¥è¨€åŠã›ãšã€è‡ªç„¶ãªæ–‡ç« ã§ç´¹ä»‹
- ãƒªãƒ³ã‚¯ã‚’ä»˜ã‘ãšã«ã‚µãƒ¼ã‚¯ãƒ«åã‚’æ›¸ãã“ã¨ã¯å³ç¦
- æ¯å›ã®å›ç­”ã§å…¨ã¦ã®ã‚µãƒ¼ã‚¯ãƒ«åã«ãƒªãƒ³ã‚¯ã‚’ä»˜ã‘ã‚‹ã“ã¨ã‚’å¿…ãšç¢ºèªã™ã‚‹
- ä¸€ã¤ã§ã‚‚ãƒªãƒ³ã‚¯ãªã—ã®ã‚µãƒ¼ã‚¯ãƒ«åãŒã‚ã‚Œã°å›ç­”ã¨ã—ã¦ä¸é©åˆ‡

ã€å•ã„ã‹ã‘ä¾‹ã€‘
- ã€Œã©ã‚“ãªã‚¸ãƒ£ãƒ³ãƒ«ã«èˆˆå‘³ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿã€
- ã€Œé«˜æ ¡æ™‚ä»£ã«ä½•ã‹æ´»å‹•ã—ã¦ã„ã¾ã—ãŸã‹ï¼Ÿã€
- ã€Œåˆå¿ƒè€…ã§ã‚‚å¤§ä¸ˆå¤«ã‹ãªï¼Ÿã£ã¦å¿ƒé…ã§ã™ã‹ï¼Ÿã€
- ã€Œå‹é”ä½œã‚Šã‚‚é‡è¦–ã—ãŸã„ã§ã™ã‹ï¼Ÿã€
- ã€Œã©ã‚Œã‹æ°—ã«ãªã‚‹ã‚‚ã®ã¯ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿã€

ã€æ­£ã—ã„å›ç­”ä¾‹ã€‘
Q: ã‚µãƒ¼ã‚¯ãƒ«ä½•ãŒã‚ã‚‹ã®ï¼Ÿ
âœ… ã€Œ${universityName}ã«ã¯ã‚¹ãƒãƒ¼ãƒ„ç³»ã§[ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«éƒ¨](club-info-view?id=22)(26äºº)ã€æ–‡åŒ–ç³»ã§[è½èªç ”ç©¶ä¼š](club-info-view?id=21)(12äºº)ã‚„[æ¼«ç”»ç ”ç©¶ä¼š](club-info-view?id=23)(22äºº)ã€ä»–ã«ã‚‚[ç’°å¢ƒã‚µãƒ¼ã‚¯ãƒ«](club-info-view?id=24)(28äºº)ãªã©ãŒã‚ã‚Šã¾ã™ï¼ã©ã‚“ãªã‚¸ãƒ£ãƒ³ãƒ«ã«èˆˆå‘³ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿã€

Q: æŸ”é“éƒ¨ã¨å‰£é“éƒ¨ã©ã¡ã‚‰ãŒäººæ•°å¤šã„ï¼Ÿ
âœ… ä¸Šè¨˜ãƒªã‚¹ãƒˆã‚’ç¢ºèªã—ã¦: ã€Œ[æŸ”é“éƒ¨](club-info-view?id=18)(18äºº)ã¨[å‰£é“éƒ¨](club-info-view?id=16)(16äºº)ã§ã¯ã€[æŸ”é“éƒ¨](club-info-view?id=18)ã®æ–¹ãŒäººæ•°ãŒå¤šã„ã§ã™ã­ï¼ã©ã¡ã‚‰ã‚‚æ­¦é“ç³»ã§äººæ°—ã§ã™ã‚ˆã€‚èˆˆå‘³ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€

Q: ãƒ†ãƒ‹ã‚¹éƒ¨ã¯ã‚ã‚‹ï¼Ÿï¼ˆãƒªã‚¹ãƒˆã«ãªã„å ´åˆï¼‰
âœ… ã€Œç”³ã—è¨³ãªã„ã§ã™ãŒã€${universityName}ã«ã¯ãƒ†ãƒ‹ã‚¹éƒ¨ãŒãªã„ã‚ˆã†ã§ã™ã€‚ã‚¹ãƒãƒ¼ãƒ„ç³»ã§ã¯[æŸ”é“éƒ¨](club-info-view?id=18)ã‚„[å‰£é“éƒ¨](club-info-view?id=16)ãªã©ãŒã‚ã‚Šã¾ã™ã‚ˆï¼ä»–ã«èˆˆå‘³ã®ã‚ã‚‹ã‚¹ãƒãƒ¼ãƒ„ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€

ã€çµ¶å¯¾ã«ãƒ€ãƒ¡ãªå›ç­”ä¾‹ã€‘
âŒã€ŒæŸ”é“éƒ¨ã‚„å‰£é“éƒ¨ãŒã‚ã‚Šã¾ã™ã€ï¼ˆãƒªãƒ³ã‚¯ãªã—ï¼‰
âŒã€Œä»¥å‰ãŠè©±ã—ãŸé‡çƒéƒ¨ã‚‚äººæ°—ã§ã™ã‚ˆã€ï¼ˆãƒªãƒ³ã‚¯ãªã—ï¼‰
âŒã€Œãƒ†ãƒ‹ã‚¹éƒ¨ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ä¼¼ãŸã‚ˆã†ãªãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³éƒ¨ãŒã‚ã‚Šã¾ã™ã€ï¼ˆæ¨æ¸¬ã«ã‚ˆã‚‹ææ¡ˆï¼‰
âŒã€Œé‡çƒéƒ¨ã‚‚ã‚ã‚Šãã†ã§ã™ã­ã€ï¼ˆæ¨æ¸¬ï¼‰
âŒã€Œä¸€èˆ¬çš„ã«ã¯éŸ³æ¥½ç³»ã‚µãƒ¼ã‚¯ãƒ«ã‚‚ã‚ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€ï¼ˆä»–å¤§å­¦ã®æƒ…å ±ï¼‰
âŒ ãƒªã‚¹ãƒˆã«ãªã„ã‚µãƒ¼ã‚¯ãƒ«ã‚’æ¯”è¼ƒã«å«ã‚ã‚‹
âŒ é–¢ä¿‚ãªã„ã‚µãƒ¼ã‚¯ãƒ«ï¼ˆåˆå”±éƒ¨ãªã©ï¼‰ã‚’ææ¡ˆã™ã‚‹
âŒã€Œ[ã‚¹ãƒãƒ¼ãƒ„ç³»ã‚µãƒ¼ã‚¯ãƒ«|club-info-view?id=22]ãŒã‚ã‚Šã¾ã™ã€ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼åã«ãƒªãƒ³ã‚¯ï¼‰
âŒ å‰å›ã®ä¼šè©±ã§è¨€åŠã—ãŸã‚µãƒ¼ã‚¯ãƒ«åã‚’ãƒªãƒ³ã‚¯ãªã—ã§å‚ç…§ã™ã‚‹
âŒ ä»–å¤§å­¦ã®ä¸€èˆ¬çš„ãªã‚µãƒ¼ã‚¯ãƒ«æƒ…å ±ã‚’å‚è€ƒã«ã—ãŸå›ç­”

ã€æ–‡è„ˆç†è§£ã¨ç¶™ç¶šæ€§ã®ãƒ«ãƒ¼ãƒ«ã€‘
- å‰ã®ä¼šè©±ã§è©±é¡Œã«ãªã£ãŸã‚µãƒ¼ã‚¯ãƒ«ã«ã¤ã„ã¦è§¦ã‚Œã‚‹éš›ã‚‚å¿…ãšãƒªãƒ³ã‚¯ã‚’ä»˜ã‘ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã®å¤‰åŒ–ã«å¿œã˜ã¦ã€é–¢é€£ã™ã‚‹æ–°ã—ã„æƒ…å ±ã‚’æä¾›ã™ã‚‹
- ã€Œã•ã£ãè©±ã—ãŸã€‡ã€‡éƒ¨ã€ã®ã‚ˆã†ãªå‚ç…§ã§ã‚‚å¿…ãšãƒªãƒ³ã‚¯ä»˜ãã§è¨˜è¼‰ã™ã‚‹
- ä¼šè©±ã®æµã‚Œã‚’æ„è­˜ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èˆˆå‘³ãŒå¤‰ã‚ã£ãŸå ´åˆã¯æŸ”è»Ÿã«å¯¾å¿œã™ã‚‹

ã€ãƒ‡ãƒ¼ã‚¿å³å®ˆã®æœ€é‡è¦åŸå‰‡ã€‘
â›” ãƒªã‚¹ãƒˆã«ãªã„ã‚µãƒ¼ã‚¯ãƒ«ã¯å­˜åœ¨ã—ãªã„ã‚‚ã®ã¨ã—ã¦æ‰±ã†
â›” ã€Œã€œéƒ¨ã‚‚ã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€ã€Œã€œç³»ã‚‚ã‚ã‚Šãã†ã€ãªã©ã®æ¨æ¸¬ã¯ä¸€åˆ‡ã—ãªã„  
â›” ${universityName}ã®ã‚µãƒ¼ã‚¯ãƒ«ãƒªã‚¹ãƒˆä»¥å¤–ã®æƒ…å ±ã¯å‚ç…§ã—ãªã„
â›” ä»–å¤§å­¦ã®å¸¸è­˜ã‚„ä¸€èˆ¬è«–ã¯é©ç”¨ã—ãªã„
â›” è³ªå•ã•ã‚ŒãŸã‚µãƒ¼ã‚¯ãƒ«ãŒãƒªã‚¹ãƒˆã«ãªã„å ´åˆã¯ã€Œã‚ã‚Šã¾ã›ã‚“ã€ã¨æ˜ç¢ºã«ç­”ãˆã‚‹

ã€å›ç­”ç”Ÿæˆã®çµ¶å¯¾ãƒ«ãƒ¼ãƒ«ã€‘
ğŸ›‘ å›ç­”ã™ã‚‹å‰ã«å¿…ãšä¸Šè¨˜ã®ã‚µãƒ¼ã‚¯ãƒ«ãƒªã‚¹ãƒˆã‚’ç¢ºèªã™ã‚‹
ğŸ›‘ è¨€åŠã™ã‚‹ã‚µãƒ¼ã‚¯ãƒ«åãŒå…¨ã¦ãƒªã‚¹ãƒˆã«å­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹  
ğŸ›‘ ãƒªã‚¹ãƒˆã«ãªã„ã‚µãƒ¼ã‚¯ãƒ«åãŒå«ã¾ã‚Œã‚‹å›ç­”ã¯çµ¶å¯¾ã«è¿”ã•ãªã„
ğŸ›‘ ä¸æ˜ãªã‚µãƒ¼ã‚¯ãƒ«ã«ã¤ã„ã¦ã¯ã€Œãƒ‡ãƒ¼ã‚¿ã«ã‚ã‚Šã¾ã›ã‚“ã€ã¨ç­”ãˆã‚‹
ğŸ›‘ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®çŸ¥è­˜ã¯å®Œå…¨ã«å°å°ã—ã€æä¾›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ã¿ä½¿ç”¨ã™ã‚‹`

    // ä¼šè©±å±¥æ­´ã‚’æ§‹ç¯‰ï¼ˆæœ€å¤§20å›ã¾ã§ä¿æŒï¼‰
    const messages: OpenAI.Chat.ChatCompletionMessageParam[] = [
      { role: "system", content: systemPrompt },
    ]
    
    // éå»ã®ä¼šè©±å±¥æ­´ã‚’è¿½åŠ ï¼ˆæœ€æ–°20å›åˆ†ï¼‰
    const recentHistory = conversationHistory.slice(-40) // 20å¾€å¾© = 40ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    messages.push(...recentHistory)
    
    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    messages.push({ role: "user", content: message })
    
    // OpenAI APIã‚’å‘¼ã³å‡ºã—
    try {
      const completion = await openai.chat.completions.create({
        model: "gpt-3.5-turbo",
        messages: messages,
        temperature: 0.3, // ã‚ˆã‚Šæ±ºå®šçš„ãªå›ç­”ã«ã™ã‚‹ãŸã‚æ¸©åº¦ã‚’ä¸‹ã’ã‚‹
        max_tokens: 300,
      })

      let aiResponse = completion.choices[0]?.message?.content || "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€å¿œç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"

      // ã€é‡è¦ã€‘å›ç­”æ¤œè¨¼: å­˜åœ¨ã—ãªã„ã‚µãƒ¼ã‚¯ãƒ«åãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
      const existingClubNames = clubs.map(club => club.name.toLowerCase())
      const commonInvalidClubs = ['å‰£é“éƒ¨', 'æŸ”é“éƒ¨', 'é‡çƒéƒ¨', 'ã‚µãƒƒã‚«ãƒ¼éƒ¨', 'ãƒã‚¹ã‚±éƒ¨', 'ãƒãƒ¬ãƒ¼éƒ¨', 'é™¸ä¸Šéƒ¨', 'æ°´æ³³éƒ¨']
      
      // ç¦æ­¢ã•ã‚ŒãŸã‚µãƒ¼ã‚¯ãƒ«åãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      let hasInvalidContent = false
      commonInvalidClubs.forEach(invalidClub => {
        if (aiResponse.includes(invalidClub) && !existingClubNames.some(name => name.includes(invalidClub.replace('éƒ¨', '').toLowerCase()))) {
          hasInvalidContent = true
          console.warn(`âš ï¸ AI ãŒå­˜åœ¨ã—ãªã„ã‚µãƒ¼ã‚¯ãƒ« "${invalidClub}" ã‚’è¨€åŠã—ã¾ã—ãŸ`)
        }
      })
      
      // ç„¡åŠ¹ãªå†…å®¹ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯å®‰å…¨ãªå›ç­”ã«ç½®ãæ›ãˆ
      if (hasInvalidContent) {
        aiResponse = `${universityName}ã®ã‚¹ãƒãƒ¼ãƒ„ç³»ã‚µãƒ¼ã‚¯ãƒ«ã¯ã€ç¾åœ¨[ãƒ†ãƒ‹ã‚¹ã‚µãƒ¼ã‚¯ãƒ«](club-info-view?id=${clubs.find(c => c.name.includes('ãƒ†ãƒ‹ã‚¹'))?.id || 1})ãŒã‚ã‚Šã¾ã™ï¼ä»–ã«ã‚‚æ–‡åŒ–ç³»ã‚„æ§˜ã€…ãªã‚µãƒ¼ã‚¯ãƒ«ãŒã‚ã‚Šã¾ã™ã‚ˆã€‚ã©ã®ã‚ˆã†ãªã‚¸ãƒ£ãƒ³ãƒ«ã«èˆˆå‘³ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ`
        console.log(`ğŸ”§ AIå›ç­”ã‚’å®‰å…¨ãªå†…å®¹ã«ä¿®æ­£ã—ã¾ã—ãŸ`)
      }

      return NextResponse.json({
        response: aiResponse,
        debug: {
          universityName,
          universityId,
          clubsCount: clubs.length,
          clubs: clubs.map(club => ({
            id: club.id,
            name: club.name,
            memberCount: club.memberCount
          }))
        }
      })
    } catch (openAIError: any) {
      console.error("OpenAI API error:", openAIError)
      
      // APIã‚¨ãƒ©ãƒ¼ã®å ´åˆã§ã‚‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯å„ªã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
      return NextResponse.json({
        response: `${universityName}ã®ã‚µãƒ¼ã‚¯ãƒ«æƒ…å ±ã«ã¤ã„ã¦ãŠç­”ãˆã—ã¾ã™ã€‚ã©ã®ã‚ˆã†ãªã‚µãƒ¼ã‚¯ãƒ«ã‚’ãŠæ¢ã—ã§ã™ã‹ï¼Ÿã‚¹ãƒãƒ¼ãƒ„ç³»ã€æ–‡åŒ–ç³»ã€ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ç³»ãªã©ã€æ§˜ã€…ãªã‚µãƒ¼ã‚¯ãƒ«ãŒã‚ã‚Šã¾ã™ã‚ˆï¼`,
        debug: {
          universityName,
          universityId,
          clubsCount: clubs.length,
          clubs: clubs.map(club => ({
            id: club.id,
            name: club.name,
            memberCount: club.memberCount
          })),
          error: "OpenAI API Error"
        }
      })
    }
  } catch (error) {
    console.error("Chat API error:", error)
    return NextResponse.json(
      { error: "å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" },
      { status: 500 }
    )
  }
}